{% extends 'predictors/base.html' %}

{% block content %}

<!-- LA SCHEDINA DELL'IA -->
{% if schedina %}
<div class="card" style="background: linear-gradient(135deg, var(--primary-color) 0%, #003380 100%); color: white; border: none; margin-bottom: 30px;">
    <h3 style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
        <span>ðŸ”¥ La Schedina dell'IA</span>
        <span style="font-size: 0.6em; font-weight: normal; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px;">Top Picks (Low Risk)</span>
    </h3>
    
    <div class="schedina-grid">
        {% for item in schedina %}
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);">
            <div>
                <div style="font-size: 0.8em; opacity: 0.8; margin-bottom: 4px;">{{ item.match.date_time|date:"H:i" }}</div>
                <div style="font-weight: bold; font-size: 0.95em;">
                    {{ item.match.home_team.short_name|default:item.match.home_team.name }}
                    <span style="opacity: 0.6; font-size: 0.8em;">vs</span>
                    {{ item.match.away_team.short_name|default:item.match.away_team.name }}
                </div>
            </div>
            <div title="{{ item.tip.reasoning }}" style="cursor: help; background: var(--accent-color); padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 1.2em; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                {{ item.tip.label }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}


<!-- SEZIONE 1: PARTITE FUTURE (PREVISIONI) -->
<div style="margin-bottom: 50px;">
    <h2>Previsioni</h2>
    
    {% for item in upcoming_matches %}
    <div class="card match-card match-card-link">

        <div class="match-card-header">
            {{ item.match.date_time|date:"D d M - H:i" }}
        </div>

        <div class="match-card-content">
            <!-- SQUADRA CASA -->
            {% include 'predictors/components/team_info.html' with team=item.match.home_team form=item.home_form %}

        <!-- Box Previsione Statistiche con BARRE -->
        {% if item.prediction %}
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; min-width: 300px; flex-grow: 1; margin: 0 20px;">
            
            <!-- Intestazione Squadre -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; font-weight: bold; color: var(--text-muted);">
                <span style="color: var(--primary-color)">{{ item.match.home_team.short_name|default:"Casa" }}</span>
                <span>VS</span>
                <span style="color: var(--accent-color)">{{ item.match.away_team.short_name|default:"Ospite" }}</span>
            </div>

            <!-- GOAL (In grande) -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8fafc; padding: 5px; border-radius: 5px;">
                <span style="font-size: 1.4em; font-weight: bold; color: var(--primary-color);">{{ item.prediction.home_goals }}</span>
                <span style="font-size: 0.8em; color: var(--text-muted);">GOAL PREVISTI</span>
                <span style="font-size: 1.4em; font-weight: bold; color: var(--accent-color);">{{ item.prediction.away_goals }}</span>
            </div>

            <!-- STATISTICHE CON BARRE -->
            <!-- Helper: widthratio calcola la percentuale: (valore / totale) * 100 -->
            
            <!-- Tiri Totali -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_total_shots }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_total_shots item.prediction.home_total_shots|add:item.prediction.away_total_shots 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_total_shots }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">TIRI TOTALI</div>

            <!-- Tiri in Porta -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_shots_on_target }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_shots_on_target item.prediction.home_shots_on_target|add:item.prediction.away_shots_on_target 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_shots_on_target }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">IN PORTA</div>

            <!-- Corner -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_corners }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_corners item.prediction.home_corners|add:item.prediction.away_corners 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_corners }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">CORNER</div>

            <!-- Falli (Inverso: meno Ã¨ meglio, ma visivamente usiamo lo stesso standard) -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_fouls }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_fouls item.prediction.home_fouls|add:item.prediction.away_fouls 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_fouls }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">FALLI</div>

            <!-- Cartellini -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_yellow_cards }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_yellow_cards item.prediction.home_yellow_cards|add:item.prediction.away_yellow_cards 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_yellow_cards }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">CARTELLINI</div>

            <!-- Fuorigioco -->
            <div class="stat-row">
                <div class="stat-val">{{ item.prediction.home_offsides }}</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-home" style="width: {% widthratio item.prediction.home_offsides item.prediction.home_offsides|add:item.prediction.away_offsides 100 %}%;"></div>
                    <div class="stat-bar-away" style="flex-grow: 1;"></div>
                </div>
                <div class="stat-val">{{ item.prediction.away_offsides }}</div>
            </div>
            <div style="text-align: center; font-size: 0.6em; color: #94a3b8; margin-top: -5px; margin-bottom: 5px;">FUORIGIOCO</div>

            <div style="text-align: center; margin-top: 15px;">
                <a href="{% url 'match_detail' item.match.id %}" class="btn" style="padding: 6px 12px; font-size: 0.8em;">Vedi Dettagli</a>
            </div>

        </div>
        {% else %}
        <div style="text-align: center; padding: 15px; opacity: 0.5;">
            <div style="font-size: 1.5em;">âŒ›</div>
            <small>In attesa...</small>
        </div>
        {% endif %}

            <!-- SQUADRA OSPITE -->
            {% include 'predictors/components/team_info.html' with team=item.match.away_team form=item.away_form %}
        </div>
    </div>
    {% empty %}
    <p style="color: var(--text-muted);">Nessuna partita programmata al momento.</p>
    {% endfor %}
</div>

{% endblock %}
{% extends 'predictors/base.html' %}
{% load static %}

{% block content %}
<!-- Intestazione Match -->
<div class="card" style="text-align: center;">
    <div>
        {{ match.league.name }} - Giornata {{ match.round_number }} - {{ match.date_time|date:"D d M Y, H:i" }}
    </div>

    <div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin: 20px 0;">
        <!-- Casa -->
        <div>
            <a href="{% url 'team_detail' match.home_team.id %}">
            {% if match.home_team.logo %}
                <img src="{{ match.home_team.logo.url }}" style="height: 80px;">
            {% else %}
                <div style="font-size: 3em;">üè†</div>
            {% endif %}
            <h2>{{ match.home_team.name }}</h2>
            </a>
            <div class="form-container">
                {% for res in home_form %}<span class="form-dot form-{{ res }}"></span>{% endfor %}
            </div>
        </div>

        <div>VS</div>

        <!-- Ospite -->
        <div>
            <a href="{% url 'team_detail' match.away_team.id %}">
            {% if match.away_team.logo %}
                <img src="{{ match.away_team.logo.url }}" style="height: 80px;">
            {% else %}
                <div style="font-size: 3em;">‚úàÔ∏è</div>
            {% endif %}
            <h2>{{ match.away_team.name }}</h2>
            </a>
            <div class="form-container">
                {% for res in away_form %}<span class="form-dot form-{{ res }}"></span>{% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Sezione Analisi IA -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    
    <!-- 1. Grafico Previsione -->
    <div class="card">
        <h3>üìä Previsione IA (Confronto)</h3>
        <canvas id="predictionChart"></canvas>
    </div>

    <!-- 2. Dati Statistici (Snapshot) -->
    <div class="card">
        <h3>üìà Forma & Statistiche (Ultime 5)</h3>
        <table>
            <thead>
                <tr>
                    <th>{{ match.home_team.short_name }}</th>
                    <th>METRICA</th>
                    <th>{{ match.away_team.short_name }}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="Media xG">{{ home_snap.avg_xg_last_5|floatformat:2 }}</td>
                    <td>Media xG</td>
                    <td data-label="Media xG">{{ away_snap.avg_xg_last_5|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td data-label="Goal Fatti">{{ home_snap.avg_goals_scored_last_5|floatformat:1 }}</td>
                    <td>Goal Fatti</td>
                    <td data-label="Goal Fatti">{{ away_snap.avg_goals_scored_last_5|floatformat:1 }}</td>
                </tr>
                <tr>
                    <td data-label="Goal Subiti">{{ home_snap.avg_goals_conceded_last_5|floatformat:1 }}</td>
                    <td>Goal Subiti</td>
                    <td data-label="Goal Subiti">{{ away_snap.avg_goals_conceded_last_5|floatformat:1 }}</td>
                </tr>
                <tr>
                    <td data-label="ELO">{{ home_snap.elo_rating|floatformat:0 }}</td>
                    <td>Power Rating (ELO)</td>
                    <td data-label="ELO">{{ away_snap.elo_rating|floatformat:0 }}</td>
                </tr>
            </tbody>
        </table>
        
        <div class="total-goals-prediction">
            <div>PREVISIONE GOAL TOTALI</div>
            <div>{{ prediction.home_goals|add:prediction.away_goals }}</div>
        </div>
    </div>
</div>

<!-- Script Grafici -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('predictionChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Goal', 'Tiri Tot', 'In Porta', 'Corner', 'Falli', 'Gialli'],
            datasets: [
                {
                    label: '{{ match.home_team.short_name }}',
                    data: [
                        {{ prediction.home_goals }}, 
                        {{ prediction.home_total_shots }},
                        {{ prediction.home_shots_on_target }},
                        {{ prediction.home_corners }},
                        {{ prediction.home_fouls }},
                        {{ prediction.home_yellow_cards }}
                    ],
                    backgroundColor: 'var(--primary-color)'
                },
                {
                    label: '{{ match.away_team.short_name }}',
                    data: [
                        {{ prediction.away_goals }}, 
                        {{ prediction.away_total_shots }},
                        {{ prediction.away_shots_on_target }},
                        {{ prediction.away_corners }},
                        {{ prediction.away_fouls }},
                        {{ prediction.away_yellow_cards }}
                    ],
                    backgroundColor: 'var(--accent-color)'
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

{% endblock %}
